## Improvement Estimates

**Goal**: Wire eligibility masks into PatternGenerator (bug fix)
**Target Metric**: Syncopation (secondary: regularity)

### Root Cause Analysis

**BUG DISCOVERED**: The eligibility mask functions exist but are never called!

- `ComputeAnchorEligibility()`, `ComputeShimmerEligibility()`, `ComputeAuxEligibility()` are implemented in `HitBudget.cpp` (lines 278+)
- They correctly constrain MINIMAL zone to `kDownbeatMask | kQuarterNoteMask` (strong beats only)
- BUT `ComputeBarBudget()` initializes eligibility to FULL MASK (lines 266-271):
  ```cpp
  outBudget.anchorEligibility  = fullMask;  // BUG: all positions eligible!
  outBudget.shimmerEligibility = fullMask;
  outBudget.auxEligibility     = fullMask;
  ```
- `PatternGenerator.cpp` calls `ComputeBarBudget()` but NEVER calls `ComputeAnchorEligibility()`
- Result: Hits can land on ANY position (16th notes), not just zone-appropriate positions

This explains why syncopation = 1.0 in stable zone: with only 2 hits that can land anywhere, they often land on weak beats (16th note positions), creating maximum syncopation.

### Proposed Fix

Modify `ComputeBarBudget()` to call the eligibility computation functions:

```cpp
void ComputeBarBudget(float energy, float balance, EnergyZone zone,
                      AuxDensity auxDensity, int patternLength,
                      float buildMultiplier, float shape, BarBudget& outBudget)
{
    // ... existing hit count computation ...

    // FIXED: Compute proper eligibility masks based on zone
    float flavor = 0.0f;  // No flavor for evaluation (firmware-only concept)
    outBudget.anchorEligibility  = ComputeAnchorEligibility(energy, flavor, zone, patternLength);
    outBudget.shimmerEligibility = ComputeShimmerEligibility(energy, flavor, zone, patternLength);
    outBudget.auxEligibility     = ComputeAuxEligibility(energy, flavor, zone, patternLength);
}
```

### Predicted Impact

**Primary Effects** (syncopation):
- Syncopation: Expected -70% to -90% reduction in stable zone
- Reasoning: MINIMAL zone eligibility restricts to quarter notes (steps 0,4,8,12,16,20,24,28) and downbeats (steps 0,16). These are all STRONG metric positions with high LHL weights. Hits on strong beats don't create syncopation tension.
- Confidence: HIGH (95%)

**Secondary Effects** (other metrics):
- Regularity: Expected +20-40% improvement
- Reasoning: Euclidean patterns landing only on quarter notes will have uniform 4-step gaps
- Density: No change expected (hit count unchanged, only positions restricted)
- voiceSeparation: Minimal change expected
- velocityRange: No change expected

**Risk Assessment**:
- Regression risk: LOW
- Potential regressions: Wild zone might become less wild (more constrained)
- Mitigation: Wild zone (PEAK) already uses kSixteenthNoteMask (all positions)

### Success Criteria

- Syncopation (stable zone): < 0.22 (target range 0.00-0.22)
- Regularity (stable zone): > 0.72 (target range 0.72-1.00)
- No metric regresses by > 2% in zones where it was already in range
- All tests pass

### Why This Will Work

This is a bug fix, not a lever adjustment. The eligibility mask system was designed and implemented but never connected. The fix completes the intended design:

1. MINIMAL zone (ENERGY < 0.2): Quarter notes + downbeats only
2. GROOVE zone (ENERGY 0.2-0.5): Quarter notes, optional 8ths
3. BUILD zone (ENERGY 0.5-0.75): 8th notes, optional 16ths
4. PEAK zone (ENERGY > 0.75): All 16th notes

This matches the spec and iteration lessons' understanding of how the system SHOULD work.

### Learning Objectives

What will this iteration teach us about:
1. Whether the eligibility mask design actually achieves intended zone behavior
2. Whether syncopation targets (0.00-0.22 for stable) are achievable
3. Whether regularity improves with constrained hit positions
