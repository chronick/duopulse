---
iteration_id: 2026-01-20-002
goal: "Tasks 70 & 71: Eligibility-aware guard rails + ENERGY zone eval coverage"
status: success
started_at: 2026-01-20T08:00:00Z
completed_at: 2026-01-20T09:30:00Z
branch: feature/tasks-70-71
commit: pending
pr: pending
estimate_accuracy: 90
---

# Iteration 2026-01-20-002: Eligibility-Aware Guard Rails + ENERGY Zone Coverage

## Goal

Implement two follow-up tasks from iteration 2026-01-20-001:
1. **Task 70**: Make guard rails respect eligibility masks when adding fill hits
2. **Task 71**: Add ENERGY zone coverage to evaluations for proper metric measurement

## Changes Made

### Task 70: Eligibility-Aware Guard Rails

**Problem**: Guard rails (`EnforceMaxGap`, `SoftRepairPass`) were adding hits without checking eligibility masks, which broke zone constraints established by the eligibility fix.

**Solution**:
1. Updated function signatures to accept eligibility masks:
   - `EnforceMaxGap(mask, eligibility, zone, length)`
   - `ApplyHardGuardRails(anchor, shimmer, eligibility, zone, genre, length)`
   - `SoftRepairPass(anchor, shimmer, anchorWeights, shimmerWeights, eligibility, zone, length)`
   - `FindRescueCandidate(mask, rescue, eligibility, weights, length)`

2. Modified gap-filling logic to find nearest eligible position:
   ```cpp
   // Old: Add hit at exact midpoint (may be ineligible)
   gapMidpoints &= eligibility;

   // New: Search outward from midpoint for nearest eligible position
   for (int offset = 0; offset < length / 2; ++offset) {
       int before = (midpoint - offset + length) % length;
       if ((eligibility & (1ULL << before)) && !(anchorMask & (1ULL << before))) {
           fillStep = before;
           break;
       }
       // ... check after position too
   }
   ```

3. Updated PatternGenerator.cpp to pass `budget.anchorEligibility` to guard rails

**Files Modified**:
- `src/Engine/GuardRails.h` - Updated function signatures
- `src/Engine/GuardRails.cpp` - Implemented eligibility filtering
- `src/Engine/PatternGenerator.cpp` - Pass eligibility to guard rails
- `tests/test_generation.cpp` - Updated tests with eligibility
- `tests/pattern_viz_test.cpp` - Updated test helper

### Task 71: ENERGY Zone Evaluation Coverage

**Problem**: Evaluation sweeps only tested SHAPE zones (stable/syncopated/wild), not ENERGY zones (MINIMAL/GROOVE/BUILD/PEAK). This meant eligibility improvements couldn't be measured.

**Solution**:
1. Added cross-product ENERGY×SHAPE sweep generation:
   ```javascript
   const ENERGY_ZONE_VALUES = [0.10, 0.35, 0.60, 0.85];  // Zone centers
   const SHAPE_VALUES = [0.0, 0.15, 0.30, 0.50, 0.70, 0.85, 1.0];
   // 4 × 7 = 28 additional patterns per sweep
   ```

2. Added ENERGY zone metrics computation and aggregation

3. Added console output for ENERGY zone pentagon:
   ```
   PENTAGON BY ENERGY ZONE:
              MINIMAL   GROOVE    BUILD     PEAK
   Sync         0.00      0.29      0.29      0.80
   Reg          1.00      0.60      0.65      0.54
   ```

4. Updated compare-metrics.js to compare ENERGY zone metrics in PR comments

**Files Modified**:
- `tools/evals/generate-patterns.js` - Added energy zone sweeps
- `tools/evals/evaluate-expressiveness.js` - Added energy zone metrics
- `scripts/compare-metrics.js` - Added energy zone comparison

## Result Metrics

### ENERGY Zone Metrics (NEW!)

| Metric | MINIMAL | GROOVE | BUILD | PEAK |
|--------|---------|--------|-------|------|
| Syncopation | 0.00 | 0.29 | 0.29 | 0.80 |
| Density | 0.10 | 0.44 | 0.56 | 0.73 |
| VelocityRange | 0.12 | 0.41 | 0.33 | 0.31 |
| VoiceSeparation | 1.00 | 0.96 | 0.78 | 0.87 |
| Regularity | 1.00 | 0.60 | 0.65 | 0.54 |

**Key Observations**:
- MINIMAL zone now shows perfect metrics: syncopation=0.00, regularity=1.00
- This proves the eligibility fix from iteration 001 is working
- ENERGY zones show appropriate metric gradients (density increases, regularity decreases)

### Test Results

- All 373 tests pass
- Added new test case: "Eligibility constrains fill positions" verifying guard rail fills respect masks

## Lessons Learned

### What We Got Right
- Eligibility-aware guard rails work correctly
- ENERGY zone metrics reveal important information not visible in SHAPE zone metrics
- MINIMAL zone (ENERGY=0.10) now achieves ideal syncopation=0.00 and regularity=1.00

### What Surprised Us
- The "nearest eligible position" search was needed - exact midpoints often land on ineligible positions
- Guard rails can make significant changes that weren't being measured before

### Implications for Future Iterations
1. **Baseline needs updating**: Should include ENERGY zone metrics
2. **CI/PR comparison**: Now shows ENERGY zone deltas
3. **Syncopation in BUILD zone**: Still at 0.29, not as low as expected - may need further investigation

## Related

- Iteration 2026-01-20-001: Eligibility mask wiring (prerequisite)
- Task 70: Eligibility-aware guard rails
- Task 71: ENERGY zone eval coverage
