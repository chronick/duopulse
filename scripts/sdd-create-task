#!/usr/bin/env sh
set -eu

INDEX="docs/tasks/index.md"
TASKS_DIR="docs/tasks"

if [ $# -lt 2 ]; then
  echo "Usage: $0 <feature-slug> <task description...>" >&2
  exit 1
fi

feature="$1"
shift
desc="$*"
task_file="$TASKS_DIR/$feature.md"
now="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

# Ensure tasks dir
mkdir -p "$TASKS_DIR"

# Ensure index with header
if [ ! -f "$INDEX" ]; then
  cat >"$INDEX" <<'EOF'
# Tasks Index

| id | feature | description | status | created_at | updated_at | file |
|----|---------|-------------|--------|------------|------------|------|
EOF
fi

# Compute next id
last_id="$(
  awk -F'|' '
    NR>2 && $2 ~ /[0-9]/ {
      gsub(/ /, "", $2);
      if ($2 > max) max = $2;
    }
    END {
      if (max == "") print 0; else print max;
    }
  ' "$INDEX"
)"
id=$((last_id + 1))

# Append row to index
echo "| $id | $feature | $desc | open | $now | $now | $task_file |" >>"$INDEX"

# Ensure feature task file exists
if [ ! -f "$task_file" ]; then
  cat >"$task_file" <<EOF
# Feature: $feature [$feature]

## Context
TODO: describe the motivation and behavior for this feature.

## Tasks

EOF
fi

# Append checklist item if not already present
if ! grep -Fq "$desc" "$task_file"; then
  printf '%s\n' "- [ ] $desc" >>"$task_file"
fi

echo "Created task #$id for feature '$feature'"
echo "  description: $desc"
echo "  file:        $task_file"

